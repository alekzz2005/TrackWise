{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">üìß Verify Your Email</h4>
                </div>
                <div class="card-body">
                    <p class="text-center">
                        We've sent a 6-digit verification code to:<br>
                        <strong id="userEmail">{{ email }}</strong>
                    </p>
                    
                    <div class="form-group text-center">
                        <label for="verificationCode">Enter Verification Code:</label>
                        <div class="d-flex justify-content-center my-3">
                            <input type="text" id="digit1" class="form-control text-center mx-1" style="width: 50px; font-size: 24px;" maxlength="1" oninput="moveToNext(1)">
                            <input type="text" id="digit2" class="form-control text-center mx-1" style="width: 50px; font-size: 24px;" maxlength="1" oninput="moveToNext(2)">
                            <input type="text" id="digit3" class="form-control text-center mx-1" style="width: 50px; font-size: 24px;" maxlength="1" oninput="moveToNext(3)">
                            <input type="text" id="digit4" class="form-control text-center mx-1" style="width: 50px; font-size: 24px;" maxlength="1" oninput="moveToNext(4)">
                            <input type="text" id="digit5" class="form-control text-center mx-1" style="width: 50px; font-size: 24px;" maxlength="1" oninput="moveToNext(5)">
                            <input type="text" id="digit6" class="form-control text-center mx-1" style="width: 50px; font-size: 24px;" maxlength="1" oninput="moveToNext(6)">
                        </div>
                        <input type="hidden" id="fullCode">
                        <div id="codeError" class="text-danger text-center mt-2" style="display: none;"></div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-success btn-lg" id="verifyBtn" onclick="verifyCode()">
                            Verify Email
                        </button>
                    </div>
                    
                    <div class="text-center mt-4">
                        <p>Didn't receive the code?</p>
                        <button class="btn btn-outline-primary" id="resendBtn" onclick="resendCode()" disabled>
                            Resend Code
                        </button>
                        <span class="text-muted ml-2" id="timerText">(Resend available in <span id="countdown">60</span> seconds)</span>
                    </div>
                    
                    <div class="text-center mt-4">
                        <a href="{% url 'accounts:role_selection' %}" class="btn btn-link">
                            ‚Üê Back to Registration
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let countdown = 60;
let timerInterval;

function startTimer() {
    const timerText = document.getElementById('timerText');
    const countdownSpan = document.getElementById('countdown');
    const resendBtn = document.getElementById('resendBtn');
    
    timerInterval = setInterval(() => {
        countdown--;
        countdownSpan.textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(timerInterval);
            resendBtn.disabled = false;
            timerText.style.display = 'none';
        }
    }, 1000);
}

function moveToNext(current) {
    const currentInput = document.getElementById(`digit${current}`);
    const nextInput = document.getElementById(`digit${current + 1}`);
    
    if (currentInput.value.length === 1 && nextInput) {
        nextInput.focus();
    }
    
    updateFullCode();
}

function updateFullCode() {
    let fullCode = '';
    for (let i = 1; i <= 6; i++) {
        fullCode += document.getElementById(`digit${i}`).value || '';
    }
    document.getElementById('fullCode').value = fullCode;
}

function verifyCode() {
    const code = document.getElementById('fullCode').value;
    const email = document.getElementById('userEmail').textContent;
    const errorDiv = document.getElementById('codeError');
    const verifyBtn = document.getElementById('verifyBtn');
    
    errorDiv.style.display = 'none';
    
    if (code.length !== 6) {
        errorDiv.textContent = 'Please enter a complete 6-digit code.';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Disable button and show loading
    verifyBtn.disabled = true;
    verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verifying...';
    
    // Send verification request
    fetch('{% url "accounts:verify_email_code" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
            email: email,
            code: code
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success - redirect to registration
            window.location.href = '{% url "accounts:business_owner_register" %}?email=' + encodeURIComponent(email);
        } else {
            errorDiv.textContent = data.error || 'Verification failed. Please try again.';
            errorDiv.style.display = 'block';
            verifyBtn.disabled = false;
            verifyBtn.innerHTML = 'Verify Email';
        }
    })
    .catch(error => {
        errorDiv.textContent = 'Network error. Please try again.';
        errorDiv.style.display = 'block';
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = 'Verify Email';
    });
}

function resendCode() {
    const email = document.getElementById('userEmail').textContent;
    const resendBtn = document.getElementById('resendBtn');
    
    resendBtn.disabled = true;
    resendBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
    
    fetch('{% url "accounts:send_verification_code" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
            email: email
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ New verification code sent! Check your email.');
            // Reset timer
            clearInterval(timerInterval);
            countdown = 60;
            document.getElementById('countdown').textContent = '60';
            document.getElementById('timerText').style.display = 'inline';
            startTimer();
        } else {
            alert('‚ùå ' + (data.error || 'Failed to resend code.'));
        }
        resendBtn.disabled = false;
        resendBtn.innerHTML = 'Resend Code';
    })
    .catch(error => {
        alert('‚ùå Network error. Please try again.');
        resendBtn.disabled = false;
        resendBtn.innerHTML = 'Resend Code';
    });
}

// Start timer when page loads
window.onload = function() {
    startTimer();
    
    // Auto-focus first input
    document.getElementById('digit1').focus();
};
</script>
{% endblock %}