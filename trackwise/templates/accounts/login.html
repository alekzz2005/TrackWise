{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/accounts/base.css' %}">
<link rel="stylesheet" href="{% static 'css/accounts/login.css' %}">
{% endblock %}

{% block title %}Login - TrackWise{% endblock %}

{% block content %}
<div class="auth-body">
    <div class="auth-container">
        <div class="logo-container">
            <div class="logo-text">
                <i class="fas fa-chart-line"></i>
                TrackWise
            </div>
        </div>
        
        <div class="form-section">
            <div class="auth-header">
                <h2>Welcome Back</h2>
                <p>Don't have an account? <a href="{% url 'accounts:business_owner_register' %}">Sign up</a></p>
            </div>
            
            {# Combined form errors container - Keep this inline since it's form-specific #}
            {% if form.non_field_errors %}
                <div class="alert alert-error form-error-alert">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="alert-content">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    <button type="button" class="alert-close" onclick="this.parentElement.style.display='none'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            {% endif %}
            
            <form method="post" id="login-form" novalidate>
                {% csrf_token %}
                
                <div class="form-group">
                    <label class="form-label" for="{{ form.username.id_for_label }}">Username *</label>
                    {{ form.username }}
                    <span class="error-message" id="username-error"></span>
                    {% if form.username.errors %}
                        {% for error in form.username.errors %}
                            <span class="error-message server-error">
                                <i class="fas fa-exclamation-circle"></i> {{ error }}
                            </span>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label" for="{{ form.password.id_for_label }}">Password *</label>
                    {{ form.password }}
                    <span class="error-message" id="password-error"></span>
                    {% if form.password.errors %}
                        {% for error in form.password.errors %}
                            <span class="error-message server-error">
                                <i class="fas fa-exclamation-circle"></i> {{ error }}
                            </span>
                        {% endfor %}
                    {% endif %}
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-success">
                        <span>Sign In</span>
                    </button>
                </div>
            </form>
            
            <div class="auth-footer">
                <p class="footer-content">
                    <a href="{% url 'accounts:landing' %}" class="footer-home-link">
                        <i class="fas fa-home"></i> Back to Home
                    </a>
                    {% comment %} <a>|</a>
                    <span class="footer-spacer"></span>
                    <a href="#" class="footer-support-link">Contact Support</a> {% endcomment %}
                </p>
            </div>
        </div>
        
        <div class="particles-section" id="particles-js"></div>
        
    </div>
</div>

{# Floating notifications container - positioned top-right #}
<div id="floating-notifications"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
<script>
    // Particles configuration
    particlesJS('particles-js', {
        particles: {
            number: { value: 80, density: { enable: true, value_area: 800 } },
            color: { value: '#7aa7e0' },
            shape: { type: 'circle' },
            opacity: { value: 0.8, random: true },
            size: { value: 20, random: true },
            line_linked: {
                enable: true,
                distance: 150,
                color: '#7aa7e0',
                opacity: 0.6,
                width: 2
            },
            move: {
                enable: true,
                speed: 1.5,
                direction: 'none',
                random: true,
                out_mode: 'out'
            }
        },
        interactivity: {
            detect_on: 'canvas',
            events: {
                onhover: { enable: true, mode: 'grab' },
                resize: true
            },
            modes: {
                grab: { distance: 180, line_linked: { opacity: 1 } }
            }
        },
        retina_detect: true
    });

    // Function to create floating notification
    function createFloatingNotification(message, type) {
        const container = document.getElementById('floating-notifications');
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `floating-notification floating-notification-${type}`;
        
        // Set icon based on message type
        let icon = 'fas fa-info-circle';
        if (type === 'error' || type === 'danger') {
            icon = 'fas fa-exclamation-circle';
        } else if (type === 'success') {
            icon = 'fas fa-check-circle';
        } else if (type === 'warning') {
            icon = 'fas fa-exclamation-triangle';
        }
        
        notification.innerHTML = `
            <div class="floating-notification-content">
                <div class="floating-notification-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="floating-notification-text">
                    ${message}
                </div>
                <button type="button" class="floating-notification-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // Add to container
        container.appendChild(notification);
        
        // Trigger animation
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        // Auto-remove after 8 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }, 8000);
    }

    // Check for Django messages on page load and display them as floating notifications
    document.addEventListener('DOMContentLoaded', function() {
        // Process Django messages
        {% if messages %}
            {% for message in messages %}
                createFloatingNotification("{{ message|escapejs }}", "{{ message.tags }}");
            {% endfor %}
        {% endif %}
        
        // Add error class to inputs that have server errors
        const serverErrors = document.querySelectorAll('.server-error');
        serverErrors.forEach(error => {
            const input = error.previousElementSibling;
            if (input && input.tagName === 'INPUT') {
                input.classList.add('error');
            }
        });
        
        // Auto-hide form error alert after 8 seconds
        setTimeout(() => {
            document.querySelectorAll('.form-error-alert').forEach(alert => {
                alert.style.opacity = '0';
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 500);
            });
        }, 8000);
    });

    // Form validation
    const form = document.getElementById('login-form');
    const usernameInput = document.getElementById('{{ form.username.id_for_label }}');
    const passwordInput = document.getElementById('{{ form.password.id_for_label }}');
    const usernameError = document.getElementById('username-error');
    const passwordError = document.getElementById('password-error');

    // Clear server errors on input
    function clearServerErrors() {
        document.querySelectorAll('.server-error').forEach(error => {
            error.style.opacity = '0.5';
            setTimeout(() => {
                error.style.display = 'none';
            }, 300);
        });
        
        // Remove any error classes from inputs
        usernameInput.classList.remove('error');
        passwordInput.classList.remove('error');
    }

    // Clear client errors
    function clearClientErrors() {
        usernameError.innerHTML = '';
        usernameError.classList.remove('show');
        passwordError.innerHTML = '';
        passwordError.classList.remove('show');
    }

    // Show error function
    function showError(inputElement, errorElement, message) {
        inputElement.classList.add('error');
        errorElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
        errorElement.classList.add('show');
        
        // Hide any server errors for this field
        const serverErrors = inputElement.parentNode.querySelectorAll('.server-error');
        serverErrors.forEach(error => {
            error.style.opacity = '0.5';
            setTimeout(() => {
                error.style.display = 'none';
            }, 300);
        });
    }

    function validateForm() {
        let isValid = true;
        
        // Clear previous client errors
        clearClientErrors();
        
        // Username validation
        const username = usernameInput.value.trim();
        if (!username) {
            showError(usernameInput, usernameError, 'Username is required');
            isValid = false;
        }

        // Password validation
        const password = passwordInput.value;
        if (!password) {
            showError(passwordInput, passwordError, 'Password is required');
            isValid = false;
        }

        return isValid;
    }

    // Clear errors on input
    [usernameInput, passwordInput].forEach(input => {
        input.addEventListener('input', () => {
            clearServerErrors();
            clearClientErrors();
            input.classList.remove('error');
        });
    });

    // Form submission
    form.addEventListener('submit', (e) => {
        if (!validateForm()) {
            e.preventDefault();
            // Scroll to first error
            const firstError = document.querySelector('.error-message.show');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else {
            // Clear all errors before submitting if form is valid
            clearClientErrors();
            clearServerErrors();
        }
    });
</script>

<style>
/* Enhanced CSS for messages and errors - Using --danger color for all errors */
:root {
    --danger: #f44336;
    --danger-dark: #da3226;
    --success: #4CAF50;
    --warning: #ff9800;
    --info: #2196F3;
}

/* Floating notifications container - TOP RIGHT */
#floating-notifications {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 400px;
    width: 90%;
    align-items: flex-end; /* Align notifications to the right */
}

/* Floating notification styles */
.floating-notification {
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    transform: translateX(100%); /* Start off-screen to the right */
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    border-left: 5px solid var(--danger);
    width: 100%;
    max-width: 380px;
}

.floating-notification.show {
    transform: translateX(0);
    opacity: 1;
}

.floating-notification-content {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    position: relative;
}

.floating-notification-icon {
    font-size: 22px;
    margin-right: 15px;
    flex-shrink: 0;
}

.floating-notification-text {
    flex: 1;
    font-weight: 500;
    font-size: 15px;
    line-height: 1.4;
    color: #333;
}

.floating-notification-close {
    background: none;
    border: none;
    color: #999;
    font-size: 18px;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
    padding: 0;
    margin-left: 10px;
    flex-shrink: 0;
}

.floating-notification-close:hover {
    opacity: 1;
    color: #333;
}

/* Notification type variations - All use danger color for the border */
.floating-notification-error,
.floating-notification-danger,
.floating-notification-warning,
.floating-notification-success,
.floating-notification-info {
    border-left-color: var(--danger);
}

.floating-notification-error .floating-notification-icon,
.floating-notification-danger .floating-notification-icon {
    color: var(--danger);
}

.floating-notification-success .floating-notification-icon {
    color: var(--success);
}

.floating-notification-warning .floating-notification-icon {
    color: var(--warning);
}

.floating-notification-info .floating-notification-icon {
    color: var(--info);
}

/* Hover effect for floating notifications */
.floating-notification:hover {
    transform: translateX(-5px); /* Move slightly left on hover */
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
}

.floating-notification.show:hover {
    transform: translateX(-5px);
}

/* Form error alert (kept inline for form errors) */
.form-error-alert {
    margin-bottom: 25px;
    background: linear-gradient(135deg, var(--danger), var(--danger-dark));
    border-color: #ff6b7d;
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.alert {
    display: flex;
    align-items: flex-start;
    padding: 18px 20px;
    border-radius: 12px;
    margin-bottom: 15px;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    border: 2px solid transparent;
    position: relative;
    transition: all 0.3s ease;
    animation: slideIn 0.5s ease-out;
    backdrop-filter: blur(5px);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alert-icon {
    font-size: 22px;
    margin-right: 15px;
    flex-shrink: 0;
    margin-top: 2px;
}

.alert-content {
    flex: 1;
    font-weight: 500;
    font-size: 15px;
    line-height: 1.5;
}

.alert-close {
    background: none;
    border: none;
    color: inherit;
    font-size: 18px;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s;
    padding: 0;
    margin-left: 10px;
    flex-shrink: 0;
    margin-top: 2px;
}

.alert-close:hover {
    opacity: 1;
}

/* Error message styling under form fields - Using --danger color */
.error-message {
    display: none;
    font-size: 14px;
    padding: 10px 12px;
    margin-top: 8px;
    border-radius: 8px;
    background: rgba(244, 67, 54, 0.15);
    border-left: 4px solid var(--danger);
    color: var(--danger);
    font-weight: 600;
    animation: fadeIn 0.3s ease;
    box-shadow: 0 2px 8px rgba(244, 67, 54, 0.1);
}

.error-message.show {
    display: flex;
    align-items: center;
}

.error-message i {
    margin-right: 8px;
    font-size: 16px;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.server-error {
    background: rgba(244, 67, 54, 0.2);
    border-left: 4px solid #ff5252;
    color: var(--danger);
}

/* Form input error state - Using --danger color */
.form-control.error {
    border-color: var(--danger) !important;
    background-color: rgba(244, 67, 54, 0.05) !important;
    box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2) !important;
    animation: shake 0.5s ease;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Input focus state with error */
.form-control.error:focus {
    border-color: var(--danger) !important;
    box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.3) !important;
}

/* Success button styling still uses success color */
.btn-success {
    background: linear-gradient(135deg, var(--success), var(--success-dark));
    border: none;
}

/* Responsive adjustments */
@media (max-width: 576px) {
    #floating-notifications {
        right: 10px;
        left: 10px;
        width: auto;
        max-width: none;
        align-items: stretch; /* Stretch to full width on mobile */
    }
    
    .floating-notification {
        width: 100%;
        max-width: none;
    }
    
    .floating-notification-content {
        padding: 14px 16px;
    }
    
    .floating-notification-icon {
        font-size: 20px;
        margin-right: 12px;
    }
    
    .floating-notification-text {
        font-size: 14px;
    }
    
    .alert {
        padding: 15px;
        flex-direction: column;
        align-items: flex-start;
    }
    
    .alert-icon {
        margin-bottom: 10px;
        margin-right: 0;
    }
    
    .alert-close {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    
    .alert-content {
        width: 100%;
    }
    
    .error-message {
        font-size: 13px;
        padding: 8px 10px;
    }
}

/* For very small screens */
@media (max-width: 360px) {
    #floating-notifications {
        right: 5px;
        left: 5px;
    }
    
    .floating-notification-content {
        padding: 12px 14px;
    }
    
    .floating-notification-icon {
        font-size: 18px;
        margin-right: 10px;
    }
    
    .floating-notification-text {
        font-size: 13px;
    }
}
</style>
{% endblock %}